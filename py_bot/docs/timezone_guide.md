# Руководство по работе с часовыми поясами

## Принцип работы с часовыми поясами

Наше приложение предназначено для пользователей по всему миру, поэтому корректная работа с часовыми поясами критически важна. В настоящее время подход системы заключается в следующем:

### Бэкенд (Python/MongoDB)

1. **Хранение данных пользователя:**
   - Для каждого пользователя в БД хранится его часовой пояс (поле `timezone`)
   - Время в базе данных хранится в формате строки, с указанием даты (например, "2023-05-25")

2. **Подсчет выигрышей:**
   - CountManager работает в UTC времени (APScheduler настроен на timezone='UTC')
   - Расчет производится в 10:05 UTC, что гарантирует, что день завершился во всех часовых поясах
   - Используется отступ в 36 часов назад, чтобы корректно обрабатывать "вчерашний день" для любого часового пояса

3. **Логика проверки выполнения привычек:**
   - Проверка выполнения привычек осуществляется по UTC дате
   - Система явно логирует даты и часовые пояса для облегчения отладки

### Фронтенд (Svelte)

1. **Получение часового пояса пользователя:**
   ```javascript
   const userTimezone = Intl.DateTimeFormat().resolvedOptions().timeZone;
   ```

2. **Форматирование дат с учетом часового пояса:**
   ```javascript
   const userDate = now.toLocaleString('en-US', { timeZone: userTimezone }).split(',')[0];
   ```

3. **Отправка часового пояса на сервер:**
   - При инициализации пользователя и обновлении last_visit
   - При создании нового пользователя

## Рекомендации по разработке

1. **Всегда используйте UTC на сервере:**
   ```python
   from datetime import datetime, timezone
   now_utc = datetime.now(timezone.utc)
   ```

2. **Никогда не используйте локальное время сервера:**
   ```python
   # Не рекомендуется:
   now = datetime.now()  # Зависит от настроек сервера
   
   # Рекомендуется:
   now = datetime.now(timezone.utc)  # Всегда UTC
   ```

3. **При сравнении и работе с датами:**
   ```python
   # Преобразуйте строку даты в объект datetime перед сравнением
   # Используйте timezone-aware объекты
   from datetime import datetime, timezone
   date_obj = datetime.strptime(date_str, "%Y-%m-%d").replace(tzinfo=timezone.utc)
   ```

4. **Для истории выполнения привычек:**
   ```python
   # Используйте формат ISO для дат
   date_str = date.strftime("%Y-%m-%d")
   ```

5. **Для фронтенда:**
   ```javascript
   // Отображайте время в локальном часовом поясе пользователя
   const localTime = new Date().toLocaleTimeString([], {
     hour: '2-digit',
     minute: '2-digit',
     timeZone: userTimezone
   });
   ```

## Отладка проблем с часовыми поясами

1. **Добавьте подробное логирование:**
   ```python
   logger.info(f"User timezone: {user['timezone']}, Check date: {check_date}, User local date: {user_local_date}")
   ```

2. **Проверяйте тестами разные сценарии часовых поясов:**
   ```python
   def test_calculate_rewards_different_timezones():
       # Тесты для пользователей из разных часовых поясов
       pass
   ```

3. **Мониторьте проблемы в продакшене:**
   - Обратите внимание на пользователей из экстремальных часовых поясов (UTC+14, UTC-12)
   - Проверяйте правильность определения "вчера" для всех часовых поясов

## Будущие улучшения

1. **Индивидуальный подсчет по часовым поясам:**
   - Можно реализовать отдельный подсчет для кластеров часовых поясов
   - Например, создать 4-6 групп часовых поясов и обрабатывать их отдельно

2. **Скользящее окно для привычек:**
   - Использовать 24-часовое окно для каждого пользователя вместо календарного дня

3. **Более детальное хранение времени:**
   - Хранить не только дату, но и время в истории привычек
   - Использовать ISO 8601 для времени с указанием часового пояса 